stages:
  - build
  - infrastructure
  - configure
  - deploy
  - test
  - cleanup

variables:
  IMAGE_NAME: "dockerhub_username/routefinale"
  IMAGE_TAG: "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
  KUBE_NAMESPACE: "routefinale"
  ANSIBLE_INVENTORY: "ansible/inventory.ini"
  GIT_BRANCH: "main"

before_script:
  - echo "Job: $CI_JOB_NAME | Stage: $CI_JOB_STAGE | Runner: $CI_RUNNER_DESCRIPTION"
  - echo "Running on $(hostname) as $(whoami)"

# ----------------- BUILD -----------------
build:
  stage: build
  script:
    - echo "ðŸš€ Building Docker image ${IMAGE_TAG}"
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_PASSWORD"
    - docker build -t "${IMAGE_TAG}" .
    - docker push "${IMAGE_TAG}"
  only:
    - $GIT_BRANCH

# ----------------- INFRASTRUCTURE (k3s single node) -----------------
infrastructure:
  stage: infrastructure
  script:
    - echo "INFRA: ensure k3s presence"
    - if command -v kubectl >/dev/null 2>&1; then echo "kubectl exists"; fi
    - if kubectl get nodes >/dev/null 2>&1; then echo "k3s already installed"; else
        echo "Installing k3s (single-node)...";
        curl -sfL https://get.k3s.io | sh -s -;
      fi
    - echo "Ensure kubeconfig is readable"
    - sudo chown $(whoami):$(whoami) /etc/rancher/k3s/k3s.yaml || true
    - cp /etc/rancher/k3s/k3s.yaml ./kubeconfig || true
    - chmod 600 ./kubeconfig || true
  when: on_success
  only:
    - $GIT_BRANCH

# ----------------- CONFIGURE -----------------
configure:
  stage: configure
  script:
    - echo "CONFIGURE: setting up build server"
    - if command -v ansible >/dev/null 2>&1; then echo "ansible already installed"; else
        sudo apt-get update -y && sudo apt-get install -y python3-pip; sudo pip3 install ansible==7.9.0;
      fi
    - ansible-playbook -i "$ANSIBLE_INVENTORY" ansible/playbook.yml --tags configure
    - if command -v gitlab-runner >/dev/null 2>&1; then echo "gitlab-runner exists"; else
        curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64;
        sudo chmod +x /usr/local/bin/gitlab-runner;
        sudo useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash || true;
        sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner || true;
        sudo gitlab-runner start || true;
      fi
    - sudo usermod -aG docker $(whoami) || true
  when: on_success
  only:
    - $GIT_BRANCH

# ----------------- DEPLOY -----------------
deploy:
  stage: deploy
  script:
    - export KUBECONFIG=$PWD/kubeconfig
    - ./scripts/deploy-local.sh
  only:
    - $GIT_BRANCH

# ----------------- TEST -----------------
test:
  stage: test
  script:
    - export KUBECONFIG=$PWD/kubeconfig
    - ./scripts/test-local.sh
  only:
    - $GIT_BRANCH

# ----------------- CLEANUP (manual) -----------------
cleanup:
  stage: cleanup
  script:
    - export KUBECONFIG=$PWD/kubeconfig
    - echo "Manual cleanup: uncomment to delete namespace"
    - echo "kubectl delete namespace $KUBE_NAMESPACE --wait=true"
  when: manual
  allow_failure: true
