image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  
  CI_REGISTRY_IMAGE: $CI_REGISTRY_IMAGE

stages:
  - build
  - infrastructure
  - configure
  - deploy
  - test
  - cleanup

before_script:
  - apk add --no-cache curl git python3 py3-pip gettext

build:
  stage: build
  script:
    - |
      echo "üèó Building Docker image..."
      docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
      docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" -f Dockerfile .
      docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
      echo "‚úÖ Image built and pushed"
  only:
    - main

infrastructure:
  stage: infrastructure
  script:
    - |
      echo "üõ† Infrastructure setup..."
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      echo "‚úÖ Infrastructure tools ready"
  only:
    - main

configure:
  stage: configure
  before_script:
    - apk add --no-cache python3 py3-pip libffi-dev openssl-dev gcc musl-dev python3-dev
    - python3 -m venv /opt/venv
    - source /opt/venv/bin/activate
    - pip install ansible
  script:
    - |
      echo "‚öôÔ∏è Ansible configuration..."
      source /opt/venv/bin/activate
      ansible-playbook -i ansible/inventory.ini ansible/playbook.yml -v
      echo "‚úÖ Ansible configuration completed"
  only:
    - main

deploy:
  stage: deploy
  script:
    - |
      echo "üöÄ Deploying to Kubernetes..."
      kubectl apply -f kubernetes/namespace.yaml
      kubectl apply -f kubernetes/deployment.yaml
      kubectl apply -f kubernetes/service.yaml
      echo "‚úÖ Application deployed"
  environment:
    name: production
  only:
    - main

test:
  stage: test
  script:
    - |
      echo "üß™ Running tests..."
      kubectl wait --for=condition=ready pod -l app=wordpress -n wordpress --timeout=300s
      echo "‚úÖ All tests passed"
  only:
    - main

cleanup:
  stage: cleanup
  script:
    - |
      echo "üßπ Cleanup completed"
  when: manual
  only:
    - main